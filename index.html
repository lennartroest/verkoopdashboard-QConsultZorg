<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verkoop Dashboard - Project Invoer</title>
    
    <style>
        :root {
            --dark-teal: #2C5F6B;
            --medium-teal: #3A6B7A;
            --light-turquoise: #4ECDC4;
            --bright-turquoise: #5FB3B3;
            --white: #ffffff;
            --light-gray: #f8f9fa;
            --gray: #666;
            --dark-gray: #333;
            --success-green: #28a745;
            --danger-red: #dc3545;
            --warning-orange: #fd7e14;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--dark-teal) 0%, var(--medium-teal) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo {
            height: 120px;
            width: auto;
        }

        .header-text {
            flex: 1;
            text-align: right;
        }

        .header h1 {
            color: var(--dark-teal);
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .header p {
            color: var(--gray);
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .full-width {
            width: 100%;
        }

        .left-section {
            max-width: 600px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .left-section {
                max-width: 100%;
            }
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            color: var(--dark-teal);
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid var(--light-turquoise);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--light-turquoise);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 500px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Medewerker sectie */
        .medewerker-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed #e0e0e0;
        }

        .medewerker-section h3 {
            color: var(--dark-teal);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .medewerker-entry {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 10px;
            padding: 12px;
            background: var(--light-gray);
            border-radius: 8px;
        }

        .medewerker-entry .form-group {
            margin-bottom: 0;
            flex: 1;
        }

        .medewerker-entry .percentage-group {
            width: 100px;
            flex: 0 0 100px;
        }

        .medewerker-entry .calculated-amount {
            width: 120px;
            flex: 0 0 120px;
            text-align: right;
            padding: 12px;
            background: #e8f4f3;
            border-radius: 8px;
            font-weight: 600;
            color: var(--success-green);
            font-size: 14px;
        }

        .btn-remove-medewerker {
            background: var(--danger-red);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .btn-remove-medewerker:hover {
            background: #c82333;
        }

        .btn-add-medewerker {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--light-gray);
            border: 2px dashed var(--light-turquoise);
            border-radius: 8px;
            cursor: pointer;
            color: var(--dark-teal);
            font-weight: 500;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-add-medewerker:hover {
            background: #e8f4f3;
            border-color: var(--dark-teal);
        }

        .btn-add-medewerker:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-add-medewerker .plus-icon {
            font-size: 20px;
            font-weight: bold;
            color: var(--light-turquoise);
        }

        /* Percentage totaal indicator */
        .percentage-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-top: 15px;
            border-radius: 8px;
            font-weight: 600;
        }

        .percentage-total.valid {
            background: #d4edda;
            color: #155724;
        }

        .percentage-total.invalid {
            background: #f8d7da;
            color: #721c24;
        }

        .percentage-total.warning {
            background: #fff3cd;
            color: #856404;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--light-turquoise), var(--bright-turquoise));
            color: white;
            width: 100%;
            margin-top: 20px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-danger {
            background: var(--danger-red);
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
        }

        /* Invoer lijst */
        .entry-list {
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .entry-item {
            padding: 15px;
            background: var(--light-gray);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .entry-project-info {
            flex: 1;
        }

        .entry-project-info .project-naam {
            font-weight: 700;
            color: var(--dark-teal);
            font-size: 1.1rem;
        }

        .entry-project-info .project-details {
            font-size: 12px;
            color: var(--gray);
            margin-top: 4px;
        }

        .entry-totaal {
            text-align: right;
        }

        .entry-totaal .label {
            font-size: 12px;
            color: var(--gray);
        }

        .entry-totaal .bedrag {
            font-weight: 700;
            color: var(--success-green);
            font-size: 1.1rem;
        }

        .entry-medewerkers {
            border-top: 1px solid #e0e0e0;
            padding-top: 10px;
            margin-top: 10px;
        }

        .entry-medewerker-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 14px;
        }

        .entry-medewerker-row .naam {
            color: var(--dark-gray);
        }

        .entry-medewerker-row .percentage {
            color: var(--gray);
            margin-left: 10px;
        }

        .entry-medewerker-row .bedrag {
            font-weight: 600;
            color: var(--dark-teal);
        }

        .entry-actions {
            margin-top: 10px;
            text-align: right;
        }

        /* Samenvattingstabel */
        .summary-table-container {
            overflow-x: auto;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .summary-table th,
        .summary-table td {
            padding: 12px 8px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }

        .summary-table th {
            background: var(--dark-teal);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .summary-table th:first-child,
        .summary-table td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: white;
            z-index: 1;
        }

        .summary-table th:first-child {
            background: var(--dark-teal);
            z-index: 2;
        }

        .summary-table tr:hover td {
            background: #f0f9f8;
        }

        .summary-table tr:hover td:first-child {
            background: #f0f9f8;
        }

        .summary-table .total-row {
            font-weight: 700;
            background: var(--light-gray);
        }

        .summary-table .total-row td {
            border-top: 2px solid var(--dark-teal);
        }

        .summary-table .total-row td:first-child {
            background: var(--light-gray);
        }

        .summary-table .total-column {
            background: #e8f4f3 !important;
            font-weight: 600;
        }

        .summary-table th.total-column {
            background: var(--medium-teal) !important;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .no-data-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        /* Datalist styling */
        input::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }

        /* Scheiding secretariaat */
        .section-divider {
            margin: 30px 0;
            text-align: center;
        }

        .section-divider-text {
            display: inline-block;
            background: white;
            padding: 8px 20px;
            color: var(--success-green);
            font-weight: 700;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
            border-radius: 5px;
        }

        .section-divider-line {
            height: 6px;
            background: var(--success-green);
            border-radius: 3px;
            margin-top: -20px;
        }

        /* Login sectie styling */
        .login-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px dashed var(--light-turquoise);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
        }

        .login-section.logged-in {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid var(--success-green);
        }

        .login-message {
            color: var(--gray);
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .login-message.success {
            color: var(--success-green);
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--success-green);
        }

        .user-email {
            font-weight: 600;
            color: var(--dark-gray);
        }

        .btn-google {
            background: white;
            color: #333;
            border: 2px solid #ddd;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .btn-google:hover {
            background: #f8f9fa;
            border-color: var(--light-turquoise);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-google svg {
            width: 20px;
            height: 20px;
        }

        .btn-logout {
            background: var(--danger-red);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: #c82333;
        }

        .form-disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .hidden {
            display: none !important;
        }
    </style>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, signOut, onAuthStateChanged, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Firebase configuratie
        const firebaseConfig = {
            apiKey: "AIzaSyBCD1NHnpqwKzoDTyu4G0FI5C6g63C6zJU",
            authDomain: "verkoop-dashboard.firebaseapp.com",
            projectId: "verkoop-dashboard",
            storageBucket: "verkoop-dashboard.firebasestorage.app",
            messagingSenderId: "244577697113",
            appId: "1:244577697113:web:8925839486f2bd91fea048"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        // Maak Firebase beschikbaar voor de rest van de code
        window.firebaseDb = db;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseDoc = doc;
        window.firebaseOnSnapshot = onSnapshot;
        window.firebaseQuery = query;
        window.firebaseOrderBy = orderBy;
        
        // Auth functies beschikbaar maken
        window.firebaseAuth = auth;
        window.firebaseGoogleProvider = googleProvider;
        window.firebaseSignInWithPopup = signInWithPopup;
        window.firebaseSignOut = signOut;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;

        // Trigger dat Firebase geladen is
        window.dispatchEvent(new Event('firebaseReady'));
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="Q-Consult Zorg Logo" class="header-logo">
            <div class="header-text">
                <h1>Verkoopdashboard</h1>
            </div>
        </div>

        <div class="main-content">
            <!-- Samenvatting tabel - volle breedte bovenaan -->
            <div class="card full-width">
                <h2><span id="currentYear"></span> - Verkoopbijdrage per medewerker</h2>
                <div class="summary-table-container">
                    <div id="summaryTable">
                        <div class="no-data">
                            <div class="no-data-icon">ðŸ“Š</div>
                            <p>Voer projecten in om de samenvatting te zien</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scheiding voor secretariaat -->
            <div class="section-divider">
                <div class="section-divider-text">Secretariaat vult dit in</div>
                <div class="section-divider-line"></div>
            </div>

            <!-- Login sectie -->
            <div class="card left-section">
                <div id="loginSection" class="login-section">
                    <p class="login-message">Log in met je Google account om projecten toe te voegen of te verwijderen.</p>
                    <button id="btnGoogleLogin" class="btn-google" onclick="loginWithGoogle()">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Inloggen met Google
                    </button>
                </div>
                
                <div id="loggedInSection" class="login-section logged-in hidden">
                    <div class="user-info">
                        <img id="userAvatar" src="" alt="Avatar" class="user-avatar">
                        <span id="userEmail" class="user-email"></span>
                    </div>
                    <p class="login-message success">Je bent ingelogd en kunt projecten beheren.</p>
                    <button id="btnLogout" class="btn-logout" onclick="logoutUser()">Uitloggen</button>
                </div>
            </div>

            <!-- Nieuw project invoeren -->
            <div class="card left-section" id="projectFormCard">
                <h2>Nieuw Project Invoeren</h2>
                
                <div id="message" class="message"></div>
                
                <form id="projectForm">
                    <!-- Project gegevens -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="datum">Datum</label>
                            <input type="date" id="datum" name="datum" required>
                        </div>
                        <div class="form-group">
                            <label for="projectnummer">Projectnummer</label>
                            <input type="text" id="projectnummer" name="projectnummer" required placeholder="Bijv. PRJ-2024-001">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="projectnaam">Naam Project</label>
                        <input type="text" id="projectnaam" name="projectnaam" required placeholder="Voer projectnaam in">
                    </div>
                    
                    <div class="form-group">
                        <label for="totaalbedrag">Totaalbedrag (â‚¬)</label>
                        <input type="number" id="totaalbedrag" name="totaalbedrag" step="0.01" min="0" required placeholder="0,00">
                    </div>
                    
                    <!-- Medewerkers sectie -->
                    <div class="medewerker-section">
                        <h3>Verdeling over Medewerkers</h3>
                        
                        <div id="medewerkerContainer">
                            <!-- Medewerker entries worden hier dynamisch toegevoegd -->
                        </div>
                        
                        <button type="button" id="btnAddMedewerker" class="btn-add-medewerker">
                            <span class="plus-icon">+</span>
                            <span>Medewerker toevoegen</span>
                        </button>
                        
                        <div id="percentageTotal" class="percentage-total warning">
                            <span>Totaal percentage:</span>
                            <span id="percentageTotalValue">0%</span>
                        </div>
                    </div>
                    
                    <button type="submit" id="btnSubmit" class="btn btn-primary" disabled>Project Toevoegen</button>
                </form>
                
                <datalist id="medewerkerList"></datalist>
            </div>

            <!-- Ingevoerde projecten -->
            <div class="card left-section">
                <h2>Ingevoerde Projecten</h2>
                <div id="entryList" class="entry-list">
                    <div class="no-data">
                        <div class="no-data-icon">ðŸ“‹</div>
                        <p>Nog geen projecten ingevoerd</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constanten
        const MONTHS = ['Jan', 'Feb', 'Mrt', 'Apr', 'Mei', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'];
        const CURRENT_YEAR = new Date().getFullYear();
        const MAX_MEDEWERKERS = 8;
        const COLLECTION_NAME = 'projecten';

        // DOM elementen
        const projectForm = document.getElementById('projectForm');
        const messageEl = document.getElementById('message');
        const entryListEl = document.getElementById('entryList');
        const summaryTableEl = document.getElementById('summaryTable');
        const medewerkerListEl = document.getElementById('medewerkerList');
        const currentYearEl = document.getElementById('currentYear');
        const medewerkerContainer = document.getElementById('medewerkerContainer');
        const btnAddMedewerker = document.getElementById('btnAddMedewerker');
        const percentageTotalEl = document.getElementById('percentageTotal');
        const percentageTotalValueEl = document.getElementById('percentageTotalValue');
        const btnSubmit = document.getElementById('btnSubmit');
        const totaalbedragInput = document.getElementById('totaalbedrag');

        // State
        let medewerkerCount = 0;
        let cachedData = []; // Cache voor data uit Firebase
        let currentUser = null; // Huidige ingelogde gebruiker

        // DOM elementen voor auth
        const loginSection = document.getElementById('loginSection');
        const loggedInSection = document.getElementById('loggedInSection');
        const userAvatar = document.getElementById('userAvatar');
        const userEmail = document.getElementById('userEmail');
        const projectFormCard = document.getElementById('projectFormCard');

        // Wacht tot Firebase geladen is
        window.addEventListener('firebaseReady', function() {
            initApp();
        });

        // =====================
        // AUTHENTICATIE FUNCTIES
        // =====================

        // Login met Google
        async function loginWithGoogle() {
            try {
                const auth = window.firebaseAuth;
                const provider = window.firebaseGoogleProvider;
                await window.firebaseSignInWithPopup(auth, provider);
                // Auth state change wordt automatisch afgehandeld door onAuthStateChanged
            } catch (error) {
                console.error('Login fout:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    showMessage('Login geannuleerd.', 'warning');
                } else {
                    showMessage('Fout bij inloggen. Probeer opnieuw.', 'error');
                }
            }
        }

        // Uitloggen
        async function logoutUser() {
            try {
                const auth = window.firebaseAuth;
                await window.firebaseSignOut(auth);
                showMessage('Je bent uitgelogd.', 'success');
            } catch (error) {
                console.error('Logout fout:', error);
                showMessage('Fout bij uitloggen. Probeer opnieuw.', 'error');
            }
        }

        // Auth state listener - reageert op login/logout
        function setupAuthListener() {
            const auth = window.firebaseAuth;
            window.firebaseOnAuthStateChanged(auth, (user) => {
                currentUser = user;
                updateAuthUI();
                renderEntryList(); // Herrender de lijst om delete knoppen te tonen/verbergen
            });
        }

        // Update UI op basis van login status
        function updateAuthUI() {
            if (currentUser) {
                // Gebruiker is ingelogd
                loginSection.classList.add('hidden');
                loggedInSection.classList.remove('hidden');
                projectFormCard.classList.remove('form-disabled');
                
                // Toon gebruiker info
                userEmail.textContent = currentUser.email;
                userAvatar.src = currentUser.photoURL || 'https://via.placeholder.com/40?text=ðŸ‘¤';
                
                console.log('Ingelogd als:', currentUser.email);
            } else {
                // Gebruiker is niet ingelogd
                loginSection.classList.remove('hidden');
                loggedInSection.classList.add('hidden');
                projectFormCard.classList.add('form-disabled');
                
                console.log('Niet ingelogd');
            }
        }

        // Maak functies globaal beschikbaar voor onclick handlers
        window.loginWithGoogle = loginWithGoogle;
        window.logoutUser = logoutUser;

        // =====================
        // INITIALISATIE
        // =====================

        function initApp() {
            currentYearEl.textContent = CURRENT_YEAR;
            
            // Zet standaard datum op vandaag
            document.getElementById('datum').valueAsDate = new Date();
            
            // Voeg eerste medewerker entry toe
            addMedewerkerEntry();
            
            // Event listeners
            btnAddMedewerker.addEventListener('click', addMedewerkerEntry);
            totaalbedragInput.addEventListener('input', updateCalculatedAmounts);
            
            // Start authenticatie listener
            setupAuthListener();
            
            // Start realtime listener voor automatische updates
            setupRealtimeListener();
        }

        // Realtime listener - update automatisch als data verandert
        function setupRealtimeListener() {
            const db = window.firebaseDb;
            const projectenRef = window.firebaseCollection(db, COLLECTION_NAME);
            
            window.firebaseOnSnapshot(projectenRef, (snapshot) => {
                cachedData = [];
                snapshot.forEach((doc) => {
                    cachedData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Render de UI met de nieuwe data
                renderAll();
                console.log('Data gesynchroniseerd:', cachedData.length, 'projecten');
            }, (error) => {
                console.error('Fout bij realtime listener:', error);
                showMessage('Fout bij laden van data. Controleer je internetverbinding.', 'error');
            });
        }

        // Medewerker entry toevoegen
        function addMedewerkerEntry() {
            if (medewerkerCount >= MAX_MEDEWERKERS) return;
            
            medewerkerCount++;
            const entryId = medewerkerCount;
            
            const entryDiv = document.createElement('div');
            entryDiv.className = 'medewerker-entry';
            entryDiv.id = `medewerker-entry-${entryId}`;
            entryDiv.innerHTML = `
                <div class="form-group">
                    <label for="medewerker-${entryId}">Medewerker</label>
                    <input type="text" id="medewerker-${entryId}" name="medewerker-${entryId}" 
                           list="medewerkerList" required placeholder="Naam medewerker"
                           oninput="updatePercentageTotal()">
                </div>
                <div class="form-group percentage-group">
                    <label for="percentage-${entryId}">%</label>
                    <input type="number" id="percentage-${entryId}" name="percentage-${entryId}" 
                           min="0" max="100" step="0.1" required placeholder="0"
                           oninput="updatePercentageTotal(); updateCalculatedAmounts()">
                </div>
                <div class="calculated-amount" id="amount-${entryId}">â‚¬ 0</div>
                ${medewerkerCount > 1 ? `
                    <button type="button" class="btn-remove-medewerker" onclick="removeMedewerkerEntry(${entryId})">
                        Ã—
                    </button>
                ` : ''}
            `;
            
            medewerkerContainer.appendChild(entryDiv);
            updateAddButton();
            updatePercentageTotal();
        }

        // Medewerker entry verwijderen
        function removeMedewerkerEntry(entryId) {
            const entry = document.getElementById(`medewerker-entry-${entryId}`);
            if (entry) {
                entry.remove();
                updateAddButton();
                updatePercentageTotal();
                updateCalculatedAmounts();
            }
        }

        // Update add button state
        function updateAddButton() {
            const currentCount = medewerkerContainer.querySelectorAll('.medewerker-entry').length;
            btnAddMedewerker.disabled = currentCount >= MAX_MEDEWERKERS;
            
            if (currentCount >= MAX_MEDEWERKERS) {
                btnAddMedewerker.querySelector('span:last-child').textContent = `Maximum bereikt (${MAX_MEDEWERKERS})`;
            } else {
                btnAddMedewerker.querySelector('span:last-child').textContent = `Medewerker toevoegen (${currentCount}/${MAX_MEDEWERKERS})`;
            }
        }

        // Update percentage totaal
        function updatePercentageTotal() {
            const entries = medewerkerContainer.querySelectorAll('.medewerker-entry');
            let total = 0;
            let allFilled = true;
            
            entries.forEach(entry => {
                const percentageInput = entry.querySelector('input[type="number"]');
                const medewerkerInput = entry.querySelector('input[type="text"]');
                const percentage = parseFloat(percentageInput.value) || 0;
                total += percentage;
                
                if (!medewerkerInput.value.trim() || !percentageInput.value) {
                    allFilled = false;
                }
            });
            
            percentageTotalValueEl.textContent = `${total.toFixed(1)}%`;
            
            // Update styling based on total
            percentageTotalEl.classList.remove('valid', 'invalid', 'warning');
            if (total === 100) {
                percentageTotalEl.classList.add('valid');
            } else if (total > 100) {
                percentageTotalEl.classList.add('invalid');
            } else {
                percentageTotalEl.classList.add('warning');
            }
            
            // Enable/disable submit button
            btnSubmit.disabled = !(total === 100 && allFilled && entries.length > 0);
        }

        // Update berekende bedragen
        function updateCalculatedAmounts() {
            const totaalbedrag = parseFloat(totaalbedragInput.value) || 0;
            const entries = medewerkerContainer.querySelectorAll('.medewerker-entry');
            
            entries.forEach(entry => {
                const percentageInput = entry.querySelector('input[type="number"]');
                const amountEl = entry.querySelector('.calculated-amount');
                const percentage = parseFloat(percentageInput.value) || 0;
                const amount = (totaalbedrag * percentage) / 100;
                amountEl.textContent = formatCurrency(amount);
            });
        }

        // Form submit handler
        projectForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Check of gebruiker ingelogd is
            if (!currentUser) {
                showMessage('Je moet ingelogd zijn om projecten toe te voegen.', 'error');
                return;
            }
            
            const datum = document.getElementById('datum').value;
            const projectnummer = document.getElementById('projectnummer').value.trim();
            const projectnaam = document.getElementById('projectnaam').value.trim();
            const totaalbedrag = parseFloat(document.getElementById('totaalbedrag').value);
            
            // Verzamel medewerker data
            const medewerkers = [];
            const entries = medewerkerContainer.querySelectorAll('.medewerker-entry');
            let totalPercentage = 0;
            
            entries.forEach(entry => {
                const medewerkerInput = entry.querySelector('input[type="text"]');
                const percentageInput = entry.querySelector('input[type="number"]');
                const naam = medewerkerInput.value.trim();
                const percentage = parseFloat(percentageInput.value) || 0;
                
                if (naam && percentage > 0) {
                    const bedrag = (totaalbedrag * percentage) / 100;
                    medewerkers.push({
                        naam: naam,
                        percentage: percentage,
                        bedrag: bedrag
                    });
                    totalPercentage += percentage;
                }
            });
            
            // Validatie
            if (!datum || !projectnummer || !projectnaam || isNaN(totaalbedrag)) {
                showMessage('Vul alle projectvelden correct in', 'error');
                return;
            }
            
            if (medewerkers.length === 0) {
                showMessage('Voeg minimaal Ã©Ã©n medewerker toe', 'error');
                return;
            }
            
            if (Math.abs(totalPercentage - 100) > 0.01) {
                showMessage(`Percentages moeten optellen tot 100% (nu: ${totalPercentage.toFixed(1)}%)`, 'error');
                return;
            }
            
            const entry = {
                createdAt: Date.now(),
                datum: datum,
                projectnummer: projectnummer,
                projectnaam: projectnaam,
                totaalbedrag: totaalbedrag,
                medewerkers: medewerkers
            };
            
            // Disable submit button tijdens opslaan
            btnSubmit.disabled = true;
            btnSubmit.textContent = 'Opslaan...';
            
            try {
                await saveEntry(entry);
                showMessage(`Project "${projectnaam}" succesvol toegevoegd!`, 'success');
                resetForm();
            } catch (error) {
                console.error('Fout bij opslaan:', error);
                showMessage('Fout bij opslaan. Probeer opnieuw.', 'error');
            } finally {
                btnSubmit.textContent = 'Project Toevoegen';
                updatePercentageTotal(); // Reset button state
            }
        });

        // Form resetten
        function resetForm() {
            document.getElementById('projectnummer').value = '';
            document.getElementById('projectnaam').value = '';
            document.getElementById('totaalbedrag').value = '';
            document.getElementById('datum').valueAsDate = new Date();
            
            // Reset medewerker entries
            medewerkerContainer.innerHTML = '';
            medewerkerCount = 0;
            addMedewerkerEntry();
        }

        // Data functies - Firebase Firestore
        function loadData() {
            // Gebruik gecachte data (wordt bijgewerkt door realtime listener)
            return cachedData;
        }

        async function saveEntry(entry) {
            const db = window.firebaseDb;
            const projectenRef = window.firebaseCollection(db, COLLECTION_NAME);
            await window.firebaseAddDoc(projectenRef, entry);
        }

        async function deleteEntry(id) {
            // Check of gebruiker ingelogd is
            if (!currentUser) {
                showMessage('Je moet ingelogd zijn om projecten te verwijderen.', 'error');
                return;
            }
            
            if (!confirm('Weet je zeker dat je dit project wilt verwijderen?')) {
                return;
            }
            
            try {
                const db = window.firebaseDb;
                const docRef = window.firebaseDoc(db, COLLECTION_NAME, id);
                await window.firebaseDeleteDoc(docRef);
                showMessage('Project verwijderd', 'success');
            } catch (error) {
                console.error('Fout bij verwijderen:', error);
                showMessage('Fout bij verwijderen. Probeer opnieuw.', 'error');
            }
        }

        // Render functies
        function renderAll() {
            renderEntryList();
            renderSummaryTable();
            updateMedewerkerDatalist();
        }

        function renderEntryList() {
            const data = loadData();
            
            if (data.length === 0) {
                entryListEl.innerHTML = `
                    <div class="no-data">
                        <div class="no-data-icon">ðŸ“‹</div>
                        <p>Nog geen projecten ingevoerd</p>
                    </div>
                `;
                return;
            }
            
            // Sorteer op datum (nieuwste eerst)
            const sortedData = [...data].sort((a, b) => new Date(b.datum) - new Date(a.datum));
            
            entryListEl.innerHTML = sortedData.map(entry => {
                const medewerkers = entry.medewerkers || [];
                const projectnaam = entry.projectnaam || 'Onbekend project';
                const projectnummer = entry.projectnummer || '-';
                const totaalbedrag = entry.totaalbedrag || 0;
                
                return `
                <div class="entry-item">
                    <div class="entry-header">
                        <div class="entry-project-info">
                            <div class="project-naam">${escapeHtml(projectnaam)}</div>
                            <div class="project-details">
                                ${escapeHtml(projectnummer)} | ${formatDate(entry.datum)}
                            </div>
                        </div>
                        <div class="entry-totaal">
                            <div class="label">Totaalbedrag</div>
                            <div class="bedrag">${formatCurrency(totaalbedrag)}</div>
                        </div>
                    </div>
                    <div class="entry-medewerkers">
                        ${medewerkers.map(m => `
                            <div class="entry-medewerker-row">
                                <span>
                                    <span class="naam">${escapeHtml(m.naam || 'Onbekend')}</span>
                                    <span class="percentage">(${m.percentage || 0}%)</span>
                                </span>
                                <span class="bedrag">${formatCurrency(m.bedrag || 0)}</span>
                            </div>
                        `).join('')}
                    </div>
                    ${currentUser ? `
                    <div class="entry-actions">
                        <button class="btn btn-danger" onclick="deleteEntry('${entry.id}')">Verwijderen</button>
                    </div>
                    ` : ''}
                </div>
            `}).join('');
        }

        function renderSummaryTable() {
            const data = loadData();
            
            // Filter alleen data van het huidige jaar
            const currentYearData = data.filter(entry => {
                const year = new Date(entry.datum).getFullYear();
                return year === CURRENT_YEAR;
            });
            
            if (currentYearData.length === 0) {
                summaryTableEl.innerHTML = `
                    <div class="no-data">
                        <div class="no-data-icon">ðŸ“Š</div>
                        <p>Voer projecten in om de samenvatting te zien</p>
                    </div>
                `;
                return;
            }
            
            // Bereken totalen per medewerker per maand
            const summary = calculateMonthlyTotals(currentYearData);
            
            // Bouw tabel HTML
            let html = '<table class="summary-table">';
            
            // Header rij
            html += '<thead><tr><th>Medewerker</th>';
            MONTHS.forEach(month => {
                html += `<th>${month}</th>`;
            });
            html += '<th class="total-column">Totaal</th></tr></thead>';
            
            // Body
            html += '<tbody>';
            
            // Data rijen per medewerker
            const medewerkers = Object.keys(summary.perMedewerker).sort();
            medewerkers.forEach(medewerker => {
                html += `<tr><td>${escapeHtml(medewerker)}</td>`;
                let rowTotal = 0;
                
                for (let month = 0; month < 12; month++) {
                    const bedrag = summary.perMedewerker[medewerker][month] || 0;
                    rowTotal += bedrag;
                    html += `<td>${bedrag > 0 ? formatCurrency(bedrag, false) : '-'}</td>`;
                }
                
                html += `<td class="total-column">${formatCurrency(rowTotal, false)}</td></tr>`;
            });
            
            // Totaal rij
            html += '<tr class="total-row"><td><strong>Totaal</strong></td>';
            let grandTotal = 0;
            
            for (let month = 0; month < 12; month++) {
                const monthTotal = summary.perMaand[month] || 0;
                grandTotal += monthTotal;
                html += `<td>${monthTotal > 0 ? formatCurrency(monthTotal, false) : '-'}</td>`;
            }
            
            html += `<td class="total-column"><strong>${formatCurrency(grandTotal, false)}</strong></td></tr>`;
            
            html += '</tbody></table>';
            
            summaryTableEl.innerHTML = html;
        }

        function calculateMonthlyTotals(data) {
            const result = {
                perMedewerker: {},
                perMaand: {}
            };
            
            data.forEach(entry => {
                const month = new Date(entry.datum).getMonth();
                const medewerkers = entry.medewerkers || [];
                
                // Loop door medewerkers van dit project
                medewerkers.forEach(m => {
                    const medewerker = m.naam || 'Onbekend';
                    const bedrag = m.bedrag || 0;
                    
                    // Per medewerker
                    if (!result.perMedewerker[medewerker]) {
                        result.perMedewerker[medewerker] = {};
                    }
                    result.perMedewerker[medewerker][month] = (result.perMedewerker[medewerker][month] || 0) + bedrag;
                    
                    // Per maand totaal
                    result.perMaand[month] = (result.perMaand[month] || 0) + bedrag;
                });
            });
            
            return result;
        }

        function updateMedewerkerDatalist() {
            const data = loadData();
            const allMedewerkers = [];
            
            data.forEach(entry => {
                const medewerkers = entry.medewerkers || [];
                medewerkers.forEach(m => {
                    const naam = m.naam || '';
                    if (naam && !allMedewerkers.includes(naam)) {
                        allMedewerkers.push(naam);
                    }
                });
            });
            
            allMedewerkers.sort();
            
            medewerkerListEl.innerHTML = allMedewerkers.map(naam => 
                `<option value="${escapeHtml(naam)}">`
            ).join('');
        }

        // Helper functies
        function showMessage(text, type) {
            messageEl.textContent = text;
            messageEl.className = `message ${type} show`;
            
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 4000);
        }

        function formatCurrency(amount, showDecimals = true) {
            return new Intl.NumberFormat('nl-NL', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: showDecimals ? 2 : 0,
                maximumFractionDigits: showDecimals ? 2 : 0
            }).format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('nl-NL', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            }).format(date);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
